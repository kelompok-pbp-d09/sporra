{% extends 'base.html' %}
{% load tz %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 py-12 px-4">
  <div class="max-w-6xl mx-auto">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-8 border-b border-gray-700 pb-4 gap-3">
      <h1 class="text-4xl font-bold text-white mb-4 sm:mb-0 flex items-center gap-3">
        ğŸŸï¸ My Bookings
        <button id="refresh-button" 
                class="inline-flex items-center bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition duration-150 text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 animate-spin hidden" id="loading-spinner" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" id="refresh-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span id="refresh-text">Refresh</span>
        </button>
      </h1>

      <a href="{% url 'event:home_event' %}" 
         class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg shadow transition">
        <i class="fa-solid fa-arrow-left"></i>
        Kembali ke Event
      </a>
    </div>

    <!-- Container Booking -->
    <div id="bookings-container">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for booking in bookings %}
          <div class="booking-card bg-gray-800 hover:bg-gray-700 hover:scale-105 transition-all duration-300 shadow-lg rounded-2xl p-6 border border-gray-700">
            <div class="flex justify-between items-start mb-3">
              <h2 class="text-xl font-semibold text-white">{{ booking.ticket.event.judul }}</h2>
              <span class="bg-blue-600 text-white text-xs font-medium px-3 py-1 rounded-full">Joined</span>
            </div>
            <hr class="border-gray-700 my-3">
            <p class="text-gray-400 text-sm mb-1">ğŸ“… {{ booking.ticket.event.date|date:"d M Y" }}</p>
            <p class="text-gray-400 text-sm mb-1">ğŸ“ {{ booking.ticket.event.lokasi|default:"Lokasi belum ditentukan" }}</p>
            <div class="mt-4 bg-gray-700/40 rounded-lg p-3">
              <p class="text-sm"><span class="font-medium text-blue-400">Quantity:</span> {{ booking.quantity }}</p>
              <p class="text-sm"><span class="font-medium text-blue-400">Total Harga:</span> Rp{{ booking.total_price|floatformat:0 }}</p>
              <p class="text-sm text-gray-400">ğŸ“† Dipesan: {{ booking.booked_at|date:"d M Y, H:i" }}</p>
            </div>
            <div class="mt-5 flex justify-between items-center">
              <a href="{% url 'event:event_detail' booking.ticket.event.id %}" 
                 class="bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                ğŸ” Lihat Event
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Template Hidden -->
    <div id="booking-card-template" class="hidden">
      <div class="booking-card bg-gray-800 hover:bg-gray-700 hover:scale-105 transition-all duration-300 shadow-lg rounded-2xl p-6 border border-gray-700">
        <div class="flex justify-between items-start mb-3">
          <h2 class="text-xl font-semibold text-white event-title"></h2>
          <span class="bg-blue-600 text-white text-xs font-medium px-3 py-1 rounded-full">Joined</span>
        </div>
        <hr class="border-gray-700 my-3">
        <p class="text-gray-400 text-sm mb-1 date"></p>
        <p class="text-gray-400 text-sm mb-1 location"></p>
        <div class="mt-4 bg-gray-700/40 rounded-lg p-3">
          <p class="text-sm"><span class="font-medium text-blue-400">Quantity:</span> <span class="quantity"></span></p>
          <p class="text-sm"><span class="font-medium text-blue-400">Total Harga:</span> Rp<span class="total-price"></span></p>
          <p class="text-sm text-gray-400 booked-at"></p>
        </div>
        <div class="mt-5 flex justify-between items-center">
          <a href="#" class="view-event bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
            ğŸ” Lihat Event
          </a>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const refreshButton = document.getElementById('refresh-button');
  const spinner = document.getElementById('loading-spinner');
  const icon = document.getElementById('refresh-icon');
  const refreshText = document.getElementById('refresh-text');
  const bookingsContainer = document.getElementById('bookings-container');
  const template = document.getElementById('booking-card-template').firstElementChild;

  async function loadBookings() {
    icon.classList.add('hidden');
    spinner.classList.remove('hidden');
    refreshText.textContent = 'Memuat...';

    try {
      const response = await fetch("{% url 'ticketing:get_my_bookings_ajax' %}");
      const data = await response.json();

      const grid = bookingsContainer.querySelector('.grid') || (() => {
        const g = document.createElement('div');
        g.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
        bookingsContainer.innerHTML = '';
        bookingsContainer.appendChild(g);
        return g;
      })();

      grid.innerHTML = '';

      if (data.bookings.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-20 bg-gray-800/40 rounded-xl border border-gray-700 shadow-inner">
            <img src="{% static 'images/no-article-found.png' %}" 
                 alt="Tidak ada booking" 
                 class="mx-auto mb-6 w-40 h-40 opacity-70">
            <p class="text-gray-300 text-lg font-semibold">Kamu belum pernah booking event apapun ğŸ˜¢</p>
            <p class="text-gray-500 mt-2">Yuk, lihat event menarik dan pesan tiket sekarang!</p>
            <a href="{% url 'event:home_event' %}"
               class="mt-6 inline-block bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-transform duration-200 hover:scale-105">
              ğŸ« Lihat Event
            </a>
          </div>`;
        return;
      }

      data.bookings.forEach(b => {
        const card = template.cloneNode(true);
        card.querySelector('.event-title').textContent = b.event_title;
        card.querySelector('.date').textContent = `ğŸ“… ${b.date}`;
        card.querySelector('.location').textContent = `ğŸ“ ${b.location}`;
        card.querySelector('.quantity').textContent = b.quantity;
        card.querySelector('.total-price').textContent = b.total_price;
        card.querySelector('.booked-at').textContent = `ğŸ“† Dipesan: ${b.booked_at}`;
        card.querySelector('.view-event').href = `/event/${b.event_id}/`;
        grid.appendChild(card);
      });

    } catch (err) {
      console.error(err);
      bookingsContainer.textContent = 'âŒ Gagal memuat booking.';
    } finally {
      spinner.classList.add('hidden');
      icon.classList.remove('hidden');
      refreshText.textContent = 'Refresh';
    }
  }

  refreshButton.addEventListener('click', loadBookings);
  loadBookings();
});
</script>

{% endblock %}
