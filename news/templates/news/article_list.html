{% extends "base.html" %}
{% load static %} 

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-white">Daftar Berita</h1>
    
    {# --- TOMBOL REFRESH --- #}
    <button id="refresh-button" 
            class="inline-flex items-center bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition duration-150 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 animate-spin hidden" id="loading-spinner" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /> </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" id="refresh-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /> </svg>
        <span id="refresh-text">Refresh</span>
    </button>
    {# -------------------- #}
</div>

{# --- FILTER KATEGORI (Tidak berubah) --- #}
<div class="flex flex-wrap gap-2 mb-6">
  <a
    href="{% url 'news:article-list' %}"
    class="py-1 px-4 rounded-full text-sm font-medium transition {% if not current_category %} bg-blue-600 text-white {% else %} bg-gray-700 text-gray-300 hover:bg-gray-600 {% endif %}"
  >
    Semua
  </a>
  {% for value, display_name in categories %}
    {% if value != 'olahraga lain' %} 
    <a href="{% url 'news:article-list' %}?category={{ value }}" 
       class="py-1 px-4 rounded-full text-sm font-medium transition {% if current_category == value %} bg-blue-600 text-white {% else %} bg-gray-700 text-gray-300 hover:bg-gray-600 {% endif %}">
      {{ display_name }}
    </a>
    {% endif %}
  {% endfor %}
  <a href="{% url 'news:article-list' %}?category=olahraga%20lain" 
     class="py-1 px-4 rounded-full text-sm font-medium transition {% if current_category == 'olahraga lain' %} bg-blue-600 text-white {% else %} bg-gray-700 text-gray-300 hover:bg-gray-600 {% endif %}">
    Olahraga Lain
  </a>
</div>

{# --- CONTAINER UNTUK GRID & PAGINATION YANG AKAN DI-REFRESH --- #}
<div id="article-list-container">
    {# Include partial template untuk tampilan awal #}
    {% include 'news/_article_grid_partial.html' with articles=articles page_obj=page_obj is_paginated=is_paginated %}
</div>

<script>
    const refreshButton = document.getElementById('refresh-button');
    const articleContainer = document.getElementById('article-list-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const refreshIcon = document.getElementById('refresh-icon');
    const refreshText = document.getElementById('refresh-text');
    // Ambil container toast global dari base.html
    const globalToastContainer = document.getElementById('toast-container'); 

    // --- FUNGSI BARU UNTUK MENAMPILKAN TOAST REFRESH ---
    function showRefreshToast(message, type = 'info') {
        if (!globalToastContainer) return; // Jangan lakukan apa-apa jika container tidak ada

        const toastElement = document.createElement('div');
        toastElement.className = `p-4 rounded-lg shadow-lg flex items-start space-x-3 text-sm font-medium toast-enter w-full`; 

        let bgColor = 'bg-blue-600'; // Default info
        let textColor = 'text-white';
        let iconSvg = `<svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>`; // Info icon
        
        if (type === 'success') {
             bgColor = 'bg-green-600';
             iconSvg = `<svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>`; // Success icon
        } else if (type === 'error') {
             bgColor = 'bg-red-600';
             iconSvg = `<svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>`; // Error icon
        }
        
        toastElement.classList.add(bgColor, textColor);

        toastElement.innerHTML = `
            <div class="flex-shrink-0">${iconSvg}</div>
            <div class="flex-grow mr-2">${message}</div>
            <div class="flex-shrink-0">
                <button type="button" class="inline-flex rounded-md p-1 -m-1 focus:outline-none focus:ring-2 focus:ring-white opacity-70 hover:opacity-100 close-toast">
                    <span class="sr-only">Dismiss</span>
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
                </button>
            </div>
        `;

        const closeButton = toastElement.querySelector('.close-toast');
        closeButton.addEventListener('click', () => removeToast(toastElement));

        globalToastContainer.appendChild(toastElement);

        requestAnimationFrame(() => {
            toastElement.classList.remove('toast-enter');
            toastElement.classList.add('toast-enter-active');
        });

        const autoCloseTimeout = setTimeout(() => removeToast(toastElement), 3000); // Durasi lebih singkat (3 detik)

        function removeToast(element) {
            clearTimeout(autoCloseTimeout); 
            element.classList.remove('toast-enter-active');
            element.classList.add('toast-exit-active');
            element.addEventListener('transitionend', () => {
                if (element.parentNode) element.parentNode.removeChild(element);
            }, { once: true }); 
        }
    }
    // --- AKHIR FUNGSI TOAST ---


    refreshButton.addEventListener('click', () => {
        // Tampilkan loading & disable tombol
        loadingSpinner.classList.remove('hidden');
        refreshIcon.classList.add('hidden');
        refreshText.textContent = 'Refreshing...';
        refreshButton.disabled = true;
        refreshButton.classList.add('opacity-50', 'cursor-not-allowed');
        
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('ajax', 'true');
        currentUrl.searchParams.delete('page'); 

        fetch(currentUrl.toString(), {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                // Jika error, lempar error agar ditangkap .catch()
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json(); 
        })
        .then(data => {
            // Ganti isi container
            articleContainer.innerHTML = data.html; 
            // --- PANGGIL FUNGSI TOAST SUKSES DI SINI ---
            showRefreshToast('Daftar berita berhasil diperbarui!', 'success'); 
            // ------------------------------------------
        })
        .catch(error => {
            console.error('Error fetching articles:', error);
            // --- PANGGIL FUNGSI TOAST ERROR DI SINI ---
            showRefreshToast('Gagal memperbarui berita.', 'error');
            // -----------------------------------------
            // Kembalikan teks tombol ke 'Error!' atau 'Refresh'
            refreshText.textContent = 'Error!'; 
        })
        .finally(() => {
            // Sembunyikan loading & enable tombol lagi
            // Hanya kembalikan teks ke 'Refresh' jika tidak error
            if (refreshText.textContent !== 'Error!') {
                 refreshText.textContent = 'Refresh';
            }
            loadingSpinner.classList.add('hidden');
            refreshIcon.classList.remove('hidden');
            refreshButton.disabled = false;
            refreshButton.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    });
</script>

{% endblock %}