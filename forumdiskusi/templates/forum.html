{% extends 'base.html' %}
{% load static %}

{% block title %}Forum Diskusi{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-10">
    <p class="text-gray-400 text-sm mb-4 text-center">
        <a href="{% url 'news:article-detail' news.pk %}" class="hover:underline text-blue-400">
            ← Kembali ke artikel
        </a>
    </p>
    <h1 class="text-3xl font-bold mb-8 text-center text-blue-400">
        Forum Diskusi: {{ news.title }}
    </h1>

    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <!-- Daftar komentar -->
    <div id="comment-list" class="space-y-4 mb-10">
        {% for comment in comments %}
        <div class="p-4 bg-gray-800 rounded-lg shadow" id="comment-{{ comment.id }}">
            <div class="flex justify-between items-start">
                <div class="flex items-center space-x-4">
                    <div class="flex flex-col items-center">
                        <button class="vote-btn text-gray-400 hover:text-blue-400" data-id="{{ comment.id }}" data-vote="up">▲</button>
                        <p id="score-{{ comment.id }}" class="text-sm font-bold text-white">{{ comment.score }}</p>
                        <button class="vote-btn text-gray-400 hover:text-red-400" data-id="{{ comment.id }}" data-vote="down">▼</button>
                    </div>
                    <div>
                        <p class="font-semibold text-blue-300">{{ comment.author.username }}</p>
                        <p class="text-gray-200 whitespace-pre-line">{{ comment.content }}</p>
                        <p class="text-sm text-gray-500 mt-1">{{ comment.created_at|date:"d M Y, H:i" }}</p>
                    </div>
                </div>

                {% if user.is_authenticated %}
                {% if comment.author == user or user.userprofile and user.userprofile.is_admin %}
                    <button class="delete-btn text-red-500 hover:text-red-600 text-sm font-medium transition"
                            data-comment-id="{{ comment.id }}">Hapus</button>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-gray-400 text-center italic">Belum ada komentar. Jadilah yang pertama!</p>
        {% endfor %}
    </div>

    {% if user.is_authenticated %}
    <div class="text-center">
        <button id="openModal" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg transition duration-200">
            Tambah Komentar
        </button>
    </div>
    {% else %}
    <p class="text-gray-400 text-center">
        Silakan <a href="{% url 'profile_user:login' %}" class="text-blue-400 hover:underline">login</a> untuk menulis komentar.
    </p>
    {% endif %}
</div>

<!-- Modal tambah komentar -->
<div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg w-96 shadow-xl">
        <h2 class="text-xl font-semibold mb-4 text-white text-center">Tulis Komentar</h2>
        <form id="commentForm">
            {% csrf_token %}
            <textarea id="commentContent" name="content" rows="4"
                class="w-full p-3 rounded bg-gray-700 text-white mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="Tulis komentar kamu di sini..."></textarea>
            <div class="flex justify-end space-x-2">
                <button type="button" id="closeModal" class="bg-gray-600 hover:bg-gray-700 px-4 py-1 rounded text-white transition">Batal</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-white transition">Kirim</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="hidden fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition z-50">
    Komentar berhasil ditambahkan!
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    let commentToDelete = null;

    function showToast(message, color="bg-green-600") {
        const t=$("#toast");
        t.removeClass("hidden bg-green-600 bg-red-600").addClass(color).text(message);
        setTimeout(()=>t.removeClass("opacity-0"),100);
        setTimeout(()=>t.addClass("opacity-0"),2500);
        setTimeout(()=>t.addClass("hidden"),3000);
    }

    // buka/tutup modal
    $("#openModal").click(()=>$("#commentModal").removeClass("hidden"));
    $("#closeModal").click(()=>$("#commentModal").addClass("hidden"));

    // tambah komentar
    $("#commentForm").submit(function(e){
        e.preventDefault();
        $.ajax({
            type:"POST",
            url:"{% url 'forumdiskusi:add_comment' news.pk %}",
            data:{
                content:$("#commentContent").val(),
                csrfmiddlewaretoken:$("input[name=csrfmiddlewaretoken]").val()
            },
            success:function(r){
                const newComment = `
                <div class="p-4 bg-gray-800 rounded-lg shadow" id="comment-${r.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center space-x-4">
                            <div class="flex flex-col items-center">
                                <button class="vote-btn text-gray-400 hover:text-blue-400" data-id="${r.id}" data-vote="up">▲</button>
                                <p id="score-${r.id}" class="text-sm font-bold text-white">0</p>
                                <button class="vote-btn text-gray-400 hover:text-red-400" data-id="${r.id}" data-vote="down">▼</button>
                            </div>
                            <div>
                                <p class="font-semibold text-blue-300">${r.username}</p>
                                <p class="text-gray-200 whitespace-pre-line">${r.content}</p>
                                <p class="text-sm text-gray-500 mt-1">${r.created_at}</p>
                            </div>
                        </div>
                        <button class="delete-btn text-red-500 hover:text-red-600 text-sm font-medium transition" data-comment-id="${r.id}">Hapus</button>
                    </div>
                </div>`;
                $("#comment-list").prepend(newComment);
                $("#commentModal").addClass("hidden");
                $("#commentContent").val("");
                showToast("Komentar berhasil ditambahkan!");
            },
            error:()=>showToast("Gagal menambahkan komentar","bg-red-600")
        });
    });

    // hapus komentar
    $(document).on("click",".delete-btn",function(){
        const id=$(this).data("comment-id");
        $.ajax({
            type:"POST",
            url:`/forumdiskusi/delete_comment/${id}/`,
            data:{csrfmiddlewaretoken:$("input[name=csrfmiddlewaretoken]").val()},
            success:()=>{
                $(`#comment-${id}`).remove();
                showToast("Komentar berhasil dihapus!");
            },
            error:()=>showToast("Gagal menghapus komentar","bg-red-600")
        });
    });

    // voting
    $(document).on("click",".vote-btn",function(){
        const id=$(this).data("id");
        const type=$(this).data("vote");
        $.ajax({
            type:"POST",
            url:`/forum/post/${id}/vote/`,
            data:{
                vote:type,
                csrfmiddlewaretoken:$("#csrf_token").val()
            },
            success:function(r){
                $(`#score-${id}`).text(r.score);
                const up=$(`#comment-${id} .vote-btn[data-vote='up']`);
                const down=$(`#comment-${id} .vote-btn[data-vote='down']`);
                up.removeClass("text-blue-400"); down.removeClass("text-red-400");
                if(r.user_vote==="up") up.addClass("text-blue-400");
                else if(r.user_vote==="down") down.addClass("text-red-400");

                // urutkan ulang TANPA .html()
                const sorted=$("#comment-list .p-4").sort((a,b)=>{
                    return parseInt($(b).find("[id^='score-']").text()) - parseInt($(a).find("[id^='score-']").text());
                });
                $("#comment-list").append(sorted);
            },
            error:()=>showToast("Gagal memproses vote","bg-red-600")
        });
    });
});
</script>
{% endblock %}
