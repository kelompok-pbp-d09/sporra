{% extends 'base.html' %}
{% load static %}

{% block title %}Forum Diskusi{% endblock %}

{% block content %}
<div class="container mx-auto py-10 px-4">
  <div class="flex flex-col lg:flex-row gap-8 items-start lg:items-start lg:content-start">

    <!--FORUM DISKUSI-->
    <div class="w-full lg:w-4/5 lg:-mt-12">
      <!-- Tombol Kembali -->
      <div class="mb-6 flex justify-start">
        <a href="{% url 'news:article-detail' news.pk %}" 
           class="font-custom1 flex items-center space-x-2 backdrop-blur-md 
                  bg-gray-700/80 text-gray-300 hover:bg-blue-600 hover:text-white 
                  transition-all px-4 py-2 rounded-full shadow-md font-medium">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span>Kembali</span>
        </a>
      </div>

      <!-- Judul -->
      <h1 class="text-3xl font-bold mb-8 text-center text-blue-400">
        Forum Diskusi: {{ news.title }}
      </h1>

      <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

      <!-- Dropdown + Tambah Komentar -->
      <div class="flex justify-end items-center mt-6 mb-4 space-x-3">
        <select id="sort-comments"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-xl 
                       shadow-lg hover:shadow-xl transition-all duration-300 focus:outline-none cursor-pointer">
          <option value="votes">Highest Votes</option>
          <option value="latest">Latest Posts</option>
        </select>

        {% if user.is_authenticated %}
          <button id="openModal"
                  class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold 
                         px-5 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" 
                 class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            <span>Tambah Komentar</span>
          </button>
        {% else %}
          <a href="{% url 'profile_user:login' %}"
             class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold 
                    px-5 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" 
                 class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            <span>Login untuk Komentar</span>
          </a>
        {% endif %}
      </div>

      <!-- Daftar komentar -->
      <div id="comment-list" class="space-y-4 mb-10">
        {% for comment in comments %}
          <div class="p-4 bg-gray-800 rounded-lg shadow relative" id="comment-{{ comment.id }}" data-date="{{ comment.created_at|date:'c' }}">
            {% if user.is_authenticated %}
              {% if comment.author == user or user.userprofile and user.userprofile.is_admin %}
                <div class="absolute top-3 right-6">
                <div class="relative inline-block text-left">
                    <button class="menu-btn text-gray-400 hover:text-white focus:outline-none text-2xl leading-none">...</button>
                    <div class="menu hidden absolute right-0 mt-2 w-40 bg-gray-700 rounded-lg shadow-lg z-10 p-2">
                    <button class="edit-btn w-full flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-3 rounded-lg text-sm transition"
                            data-comment-id="{{ comment.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Edit
                    </button>
                    <button class="delete-btn w-full flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg text-sm transition mt-2"
                            data-comment-id="{{ comment.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Hapus
                    </button>
                    </div>
                </div>
                </div>
              {% endif %}
            {% endif %}

            <!-- isi komentar -->
            <div class="flex items-start space-x-4">
              <div class="flex flex-col items-center">
                <button class="vote-btn {% if comment.user_vote == 1 %}text-blue-400{% else %}text-gray-400 hover:text-blue-400{% endif %}"
                        data-id="{{ comment.id }}" data-vote="up">▲</button>
                <p id="score-{{ comment.id }}" class="text-center text-white">{{ comment.score }}</p>
                <button class="vote-btn {% if comment.user_vote == -1 %}text-red-400{% else %}text-gray-400 hover:text-red-400{% endif %}"
                        data-id="{{ comment.id }}" data-vote="down">▼</button>
              </div>
              <div class="flex-1 min-w-0">
                <a href="{% url 'profile_user:show_profile' comment.author.username %}" class="text-blue-300 hover:text-blue-400 transition duration-150">
                    {{ comment.author.username|default:"Unknown" }}
                </a>
                <p id="comment-content-{{ comment.id }}" class="text-gray-200 whitespace-pre-line mt-1 break-words">{{ comment.content }}</p>
                <p class="text-sm text-gray-500 mt-1">{{ comment.created_at|date:"d M Y, H:i" }}</p>
              </div>
            </div>
          </div>
        {% empty %}
        <div id="no-comments" class="flex flex-col items-center justify-center gap-4 py-12">
            <img src="{% static 'images/no-article-found.png' %}" alt="Belum ada komentar" class="w-40 h-40 object-contain opacity-90">
            <p class="text-gray-300 text-center max-w-xs">
            Belum ada komentar di forum ini.
            Jadilah yang pertama!
            </p>
            {% if user.is_authenticated %}
            <button id="openModalPlaceholder"
                    class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                Tambah Komentar
            </button>
            {% else %}
            <a href="{% url 'profile_user:login' %}" class="mt-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                Login untuk Berkomentar
            </a>
            {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- SIDEBAR KANAN -->
    <aside class="w-full lg:w-1/5 self-start mt-20 lg:mt-[6.5rem]">
            <div class="mb-12">
                <h2 class="text-2xl font-bold text-white mb-6 text-center lg:text-left">
                    Top Forum
                </h2>

                <ol class="space-y-4 list-none p-0"> 
                    {% for top_forum in top_forums %}
                    <li class="group flex items-start text-white/90">
                        <span class="mr-3 text-xl font-bold text-blue-400" 
                            style="width: 25px;">
                            #{{ forloop.counter }}
                        </span>
                        
                        <a href="{% url 'forumdiskusi:forum' pk=top_forum.article.pk %}"
                        class="block flex-1 text-gray-300 hover:text-blue-400 transition">
                            
                            <span class="font-semibold text-white group-hover:text-blue-400 leading-snug">
                                {{ top_forum.article.title|truncatechars:70 }}
                            </span>
                            
                            <p class="text-xs text-gray-500 mt-0.5">
                                {{ top_forum.post_count }} Komentar
                            </p>
                        </a>
                    </li>
                    {% empty %}
                    <p class="text-gray-400 text-center">Belum ada forum ramai.</p>
                    {% endfor %}
                </ol>
            </div>
            <h2 class="text-2xl font-bold text-white mb-6 text-center lg:text-left">
                Lihat Lainnya
            </h2>

            <div class="space-y-4">
                {% for article in hottest_articles %}
                <a href="{{ article.get_absolute_url }}" 
                    class="block bg-gray-800 rounded-lg shadow-md hover:shadow-xl overflow-hidden transform hover:scale-[1.02] transition">
                    <div class="h-32 overflow-hidden">
                        {% if article.thumbnail %}
                        <img src="{{ article.thumbnail }}" alt="{{ article.title }}" 
                                class="w-full h-full object-cover transition duration-300 hover:scale-110">
                        {% else %}
                        <img src="{% static 'images/no-image-news.jpg' %}" alt="Tidak ada gambar"
                                class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div class="p-3">
                        <h3 class="text-white font-semibold text-sm mb-1 hover:text-blue-400 transition">
                            {{ article.title|truncatechars:60 }}
                        </h3>
                        <p class="text-xs text-gray-400">by {{ article.author.username|default:"Unknown" }}</p>
                    </div>
                </a>
                {% empty %}
                <p class="text-gray-400 text-center">Tidak ada berita trending.</p>
                {% endfor %}
            </div>
        </aside>

    <!-- Modal Tambah Komentar -->
    <div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-gray-800 text-white rounded-2xl shadow-2xl p-8 w-11/12 max-w-2xl">
        <h2 class="text-2xl font-bold mb-6 text-center">Tambah Komentar</h2>
        <form id="commentForm">
        {% csrf_token %}
        <textarea id="commentContent" rows="6"
            class="w-full p-4 rounded-lg bg-gray-700 text-white focus:outline-none 
                focus:ring-2 focus:ring-blue-500 resize-none min-h-[200px] text-base"
            placeholder="Tulis komentar kamu di sini..." required></textarea>
        <div class="mt-6 flex justify-end space-x-4">
            <button type="button" id="closeModal"
            class="px-5 py-2.5 rounded-lg bg-gray-600 hover:bg-gray-700 text-white text-base transition">
            Batal
            </button>
            <button type="submit"
            class="px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold text-base transition">
            Kirim
            </button>
        </div>
        </form>
    </div>
    </div>

    <!-- Modal Edit Komentar -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 text-white rounded-2xl shadow-2xl p-8 w-11/12 max-w-2xl">
        <h2 class="text-2xl font-bold mb-6 text-center">Edit Komentar</h2>
        <form id="editCommentForm">
        {% csrf_token %}
        <textarea id="editCommentContent" rows="6"
            class="w-full p-4 rounded-lg bg-gray-700 text-white focus:outline-none 
                focus:ring-2 focus:ring-blue-500 resize-none min-h-[200px] text-base"
            placeholder="Edit komentar kamu di sini..." required></textarea>
        <div class="mt-6 flex justify-end space-x-4">
            <button type="button" id="cancelEdit"
            class="px-5 py-2.5 rounded-lg bg-gray-600 hover:bg-gray-700 text-white text-base transition">
            Batal
            </button>
            <button type="submit"
            class="px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold text-base transition">
            Simpan Perubahan
            </button>
        </div>
        </form>
    </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition z-50">
        Komentar berhasil ditambahkan!
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    let editingCommentId = null;

    // === TOAST ===
    function showToast(message, color="bg-green-600") {
        const t=$("#toast");
        t.removeClass("hidden bg-green-600 bg-red-600").addClass(color).text(message);
        setTimeout(()=>t.removeClass("opacity-0"),100);
        setTimeout(()=>t.addClass("opacity-0"),2500);
        setTimeout(()=>t.addClass("hidden"),3000);
    }

    // === PLACEHOLDER HANDLER ===
    function updateEmptyState() {
        const hasComments = $("#comment-list > .p-4").length > 0;
        if (hasComments) {
            $("#no-comments").addClass("hidden");
        } else {
            $("#no-comments").removeClass("hidden");
        }
    }

    // === MODAL TAMBAH KOMENTAR ===
    $("#openModal, #openModalPlaceholder").click(()=>$("#commentModal").removeClass("hidden"));
    $("#closeModal").click(()=>$("#commentModal").addClass("hidden"));

    // === MODAL EDIT KOMENTAR ===
    function openEditModal(id, content) {
        editingCommentId = id;
        $("#editCommentContent").val(content).trigger('input');
        $("#editModal").removeClass("hidden");
    }
    $("#cancelEdit").click(()=>{ $("#editModal").addClass("hidden"); editingCommentId=null; });

    // === AUTO-RESIZE TEXTAREA ===
    $(document).on("input", "#editCommentContent, #commentContent", function() {
      this.style.height = "auto";
      this.style.height = (this.scrollHeight) + "px";
    });

    // === SUBMIT EDIT KOMENTAR ===
    $("#editCommentForm").submit(function(e){
        e.preventDefault();
        const newContent=$("#editCommentContent").val().trim();
        if(!newContent) return;

        $.ajax({
            type:"POST",
            url:`/forum/edit_comment/${editingCommentId}/`,
            data:{
                content:newContent,
                csrfmiddlewaretoken:$("input[name=csrfmiddlewaretoken]").val()
            },
            success:function(r){
                if(r.success){
                    $(`#comment-content-${editingCommentId}`).text(newContent);
                    $("#editModal").addClass("hidden");
                    showToast("Komentar berhasil diperbarui!");
                } else showToast(r.error||"Gagal menyimpan perubahan","bg-red-600");
            },
            error:(xhr)=>{
                let message="Gagal mengedit komentar";
                if(xhr.status===403) message="Kamu tidak punya izin untuk mengedit komentar ini";
                showToast(message,"bg-red-600");
            }
        });
    });

    // === KLIK TOMBOL EDIT ===
    $(document).on("click",".edit-btn", function(){
        const id=$(this).data("comment-id");
        const oldContent=$(`#comment-content-${id}`).text().trim();
        openEditModal(id, oldContent);
    });

    // === HAPUS KOMENTAR ===
    $(document).on("click",".delete-btn", function(){
        const id=$(this).data("comment-id");
        $.ajax({
            type:"POST",
            url:`/forum/delete_comment/${id}/`,
            data:{csrfmiddlewaretoken:$("input[name=csrfmiddlewaretoken]").val()},
            success:function(){
                $(`#comment-${id}`).fadeOut(300,function(){
                    $(this).remove();
                    updateEmptyState(); // cek lagi setelah hapus
                });
                showToast("Komentar berhasil dihapus!");
            },
            error:(xhr)=>{
                let msg="Gagal menghapus komentar";
                if(xhr.status===403) msg="Kamu tidak punya izin menghapus komentar ini";
                showToast(msg,"bg-red-600");
            }
        });
    });

    // === VOTING KOMENTAR ===
    $(document).on("click",".vote-btn", function(){
        const id=$(this).data("id");
        const type=$(this).data("vote");
        $.ajax({
            type:"POST",
            url:`/forum/post/${id}/vote/`,
            data:{vote:type,csrfmiddlewaretoken:$("#csrf_token").val()},
            success:function(r){
                $(`#score-${id}`).text(r.score);
                const up=$(`#comment-${id} .vote-btn[data-vote='up']`);
                const down=$(`#comment-${id} .vote-btn[data-vote='down']`);
                up.removeClass("text-blue-400").addClass("text-gray-400 hover:text-blue-400");
                down.removeClass("text-red-400").addClass("text-gray-400 hover:text-red-400");
                if(r.user_vote===1) up.removeClass("text-gray-400").addClass("text-blue-400");
                else if(r.user_vote===-1) down.removeClass("text-gray-400").addClass("text-red-400");

                const currentSort = $("#sort-comments").val();
                if (currentSort === "votes") {
                    const sorted = $("#comment-list > .p-4").sort((a, b) => {
                        const scoreA = parseInt($(a).find("[id^='score-']").text()) || 0;
                        const scoreB = parseInt($(b).find("[id^='score-']").text()) || 0;
                        return scoreB - scoreA;
                    });
                    $("#comment-list").html(sorted);
                }
            },
            error:()=>alert("Gagal memproses vote")
        });
    });

    // === TAMBAH KOMENTAR ===
    $("#commentForm").submit(function(e){
        e.preventDefault();
        $.ajax({
            type:"POST",
            url:"{% url 'forumdiskusi:add_comment' news.pk %}",
            data:{
                content:$("#commentContent").val(),
                csrfmiddlewaretoken:$("input[name=csrfmiddlewaretoken]").val()
            },
            success: function(r){
                const newComment = `
                <div class="p-4 bg-gray-800 rounded-lg shadow relative" id="comment-${r.id}" data-date="${r.created_at}">
                <div class="absolute top-3 right-3">
                    <div class="relative inline-block text-left">
                    <button class="menu-btn text-gray-400 hover:text-white focus:outline-none">...</button>
                    <div class="menu hidden absolute right-0 mt-2 w-40 bg-gray-700 rounded-lg shadow-lg z-10 p-2">
                        <button class="edit-btn w-full flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-3 rounded-lg text-sm transition"
                                data-comment-id="${r.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Edit
                        </button>
                        <button class="delete-btn w-full flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg text-sm transition mt-2"
                                data-comment-id="${r.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Hapus
                        </button>
                    </div>
                    </div>
                </div>
                <div class="flex items-start space-x-4">
                    <div class="flex flex-col items-center">
                    <button class="vote-btn text-gray-400 hover:text-blue-400" data-id="${r.id}" data-vote="up">▲</button>
                    <p id="score-${r.id}" class="text-center text-white">0</p>
                    <button class="vote-btn text-gray-400 hover:text-red-400" data-id="${r.id}" data-vote="down">▼</button>
                    </div>
                    <div class="flex-1 min-w-0">
                    <p class="font-semibold text-blue-300">${r.username}</p>
                    <p id="comment-content-${r.id}" class="text-gray-200 whitespace-pre-line mt-1 break-words">${r.content}</p>
                    <p class="text-sm text-gray-500 mt-1">${r.created_at}</p>
                    </div>
                </div>
                </div>`;


                $("#comment-list").prepend(newComment);
                $("#commentModal").addClass("hidden");
                $("#commentContent").val("").trigger('input');
                showToast("Komentar berhasil ditambahkan!");
                $("#sort-comments").trigger("change");
                updateEmptyState(); // hide placeholder
            },
            error:()=>showToast("Gagal menambahkan komentar","bg-red-600")
        });
    });

    // SORTING KOMENTAR
    $("#sort-comments").change(function() {
        const sortType = $(this).val();
        const comments = $("#comment-list > .p-4").toArray();

        // Kalau gak ada komentar sama sekali, jangan hapus placeholder
        if (comments.length === 0) {
            updateEmptyState();
            return;
        }

        comments.sort((a, b) => {
            if (sortType === "votes") {
                const scoreA = parseInt($(a).find("[id^='score-']").text()) || 0;
                const scoreB = parseInt($(b).find("[id^='score-']").text()) || 0;
                return scoreB - scoreA;
            } else if (sortType === "latest") {
                const dateA = new Date($(a).data("date"));
                const dateB = new Date($(b).data("date"));
                return dateB - dateA;
            }
        });

        $("#comment-list").html(comments);
        updateEmptyState();
    });

    $("#sort-comments").trigger("change");
});

// === MENU DROPDOWN ===
$(document).on("click", ".menu-btn", function(e) {
  e.stopPropagation();
  const menu = $(this).siblings(".menu");
  $(".menu").not(menu).addClass("hidden");
  menu.toggleClass("hidden");
});
$(document).click(function() { $(".menu").addClass("hidden"); });
</script>
{% endblock %}